<%+header%>

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 数据包捕获网页界面。捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<div>
					<select id="interface" class="cbi-input-select">
						<option value=""><%:正在加载接口...%></option>
					</select>
					<button id="btn-refresh" class="cbi-button cbi-button-neutral" onclick="refreshInterfaces()" title="<%:刷新网络接口列表%>">
						<%:刷新接口%>
					</button>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络数据过滤器%></label>
			<div class="cbi-value-field">
				<div>
					<select id="port-preset" class="cbi-input-select">
						<option value=""><%:选择端口...%></option>
						<option value="port 80">80 (HTTP)</option>
						<option value="port 443">443 (HTTPS)</option>
						<option value="port 53">53 (DNS)</option>
						<option value="port 67">67 (DHCP)</option>
						<option value="port 68">68 (DHCP)</option>
						<option value="port 22">22 (SSH)</option>
						<option value="custom"><%:自定义端口...%></option>
					</select>
					<input type="text" id="filter" class="cbi-input-text" placeholder="<%:自定义 BPF 过滤器，例如: host 192.168.1.1 or icmp%>" />
				</div>
				
				<!-- 自定义端口输入框 -->
				<div id="custom-port-container" style="display: none; margin-top: 5px;">
					<div>
						<input type="number" id="custom-port" class="cbi-input-text" placeholder="<%:输入端口号%>" min="1" max="65535" style="width: 120px;" />
						<div>
							<button id="btn-apply-custom-port" class="cbi-button cbi-button-positive" title="<%:应用自定义端口过滤器%>">
								<%:应用%>
							</button>
							<button id="btn-cancel-custom-port" class="cbi-button cbi-button-neutral" title="<%:取消自定义端口设置%>">
								<%:取消%>
							</button>
						</div>
					</div>
				</div>
				
				<div class="cbi-value-description">
					<%:使用 BPF 语法，留空捕获所有流量。可从左侧选择常用端口或右侧输入自定义过滤器。%>
				</div>
			</div>
		</div>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:文件大小限制 (MB)%></label>
			<div class="cbi-value-field">
				<div>
					<div>
						<input type="number" id="filesize" class="cbi-input-text" placeholder="10" min="1" max="100" style="width: 80px;" />
						<span><%:MB%></span>
					</div>
					<div id="file-size-display" style="display: none;">
						<span><%:当前捕获文件大小:%> </span><span id="current-file-size">0 KB</span>
					</div>
				</div>
				<div class="cbi-value-description">
					<%:最大文件大小 (1-100MB)，留空表示无限制%>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:状态%></label>
			<div class="cbi-value-field">
				<div id="status-container">
					<span id="status-text">
						<%:加载中...%>
					</span>
				</div>
			</div>
		</div>

		<div class="cbi-value cbi-value-last">
			<label class="cbi-value-title"><%:操作%></label>
			<div class="cbi-value-field">
				<div>
					<button id="btn-start" class="cbi-button cbi-button-positive" onclick="startCapture()" title="<%:开始数据包捕获%>">
						<%:开始捕获%>
					</button>
					<button id="btn-stop" class="cbi-button cbi-button-neutral" onclick="stopCapture()" disabled title="<%:停止数据包捕获%>">
						<%:停止捕获%>
					</button>
					<button id="btn-download" class="cbi-button cbi-button-download" onclick="downloadCapture()" disabled title="<%:下载捕获文件%>">
						<%:下载文件%>
					</button>
					<button id="btn-delete" class="cbi-button cbi-button-remove" onclick="deleteCapture()" disabled title="<%:删除捕获文件%>">
						<%:删除文件%>
					</button>
				</div>
			</div>
		</div>
	</fieldset>
</div>

<script type="text/javascript">
//<![CDATA[

// ------------------------------------------------
// 工具函数
// ------------------------------------------------
function formatFileSize(bytes) {
    if (bytes === 0 || !bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ------------------------------------------------
// 端口选择器逻辑
// ------------------------------------------------
function setupPortSelector() {
    var portPreset = document.getElementById('port-preset');
    var filterInput = document.getElementById('filter');
    var customPortContainer = document.getElementById('custom-port-container');
    var customPortInput = document.getElementById('custom-port');
    var applyCustomPortBtn = document.getElementById('btn-apply-custom-port');
    var cancelCustomPortBtn = document.getElementById('btn-cancel-custom-port');
    
    if (portPreset && filterInput) {
        portPreset.addEventListener('change', function() {
            if (this.value === 'custom') {
                customPortContainer.style.display = 'block';
                customPortInput.focus();
            } else if (this.value) {
                filterInput.value = this.value;
                customPortContainer.style.display = 'none';
                customPortInput.value = '';
            } else {
                filterInput.value = '';
                customPortContainer.style.display = 'none';
                customPortInput.value = '';
            }
        });
        
        applyCustomPortBtn.addEventListener('click', function() {
            var port = customPortInput.value.trim();
            if (port && !isNaN(port) && port > 0 && port <= 65535) {
                filterInput.value = 'port ' + port;
                customPortContainer.style.display = 'none';
                customPortInput.value = '';
                portPreset.value = '';
            } else {
                alert('<%:请输入有效的端口号 (1-65535)%>');
            }
        });
        
        cancelCustomPortBtn.addEventListener('click', function() {
            customPortContainer.style.display = 'none';
            customPortInput.value = '';
            portPreset.value = '';
        });
        
        customPortInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                applyCustomPortBtn.click();
            }
        });
        
        filterInput.addEventListener('input', function() {
            if (this.value !== portPreset.value) {
                portPreset.value = '';
                customPortContainer.style.display = 'none';
                customPortInput.value = '';
            }
        });
        
        filterInput.addEventListener('focus', function() {
            this.select();
        });
    }
}

// ------------------------------------------------
// 接口管理
// ------------------------------------------------
function loadInterfaces() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/interfaces")%>', true);
    xhr.timeout = 10000;
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var select = document.getElementById('interface');
            
            if (xhr.status === 200) {
                try {
                    var interfaces = JSON.parse(xhr.responseText);
                    
                    if (!interfaces || interfaces.length === 0) {
                        select.innerHTML = '<option value=""><%:未找到网络接口%></option>';
                        return;
                    }
                    
                    select.innerHTML = '';
                    var brLanExists = interfaces.includes('br-lan');
                    
                    interfaces.forEach(function(iface) {
                        var option = document.createElement('option');
                        option.value = iface;
                        
                        if (iface === 'br-lan') {
                            option.textContent = 'br-lan (<%:默认%>)';
                            option.selected = true;
                        } else {
                            option.textContent = iface;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    if (!brLanExists && interfaces.length > 0) {
                        select.firstChild.selected = true;
                    }
                    
                } catch(e) {
                    console.error('<%:加载接口时出错 (JSON解析失败)%>:', e);
                    select.innerHTML = '<option value=""><%:加载接口失败%></option>';
                }
            } else {
                console.error('<%:加载接口失败，状态码:%>', xhr.status);
                select.innerHTML = '<option value=""><%:加载接口失败 (HTTP %> ' + xhr.status + ')</option>';
            }
        }
    };
    
    xhr.ontimeout = function() {
        console.error('<%:加载接口请求超时%>');
    };
    
    xhr.send();
}

// ------------------------------------------------
// 状态管理
// ------------------------------------------------
var tcpdumpState = {
    isUpdating: false,
    lastUpdate: 0,
    updateInterval: 3000
};

function updateStatus() {
    if (tcpdumpState.isUpdating) return;
    
    var now = Date.now();
    if (now - tcpdumpState.lastUpdate < 1000) return;
    
    tcpdumpState.isUpdating = true;
    tcpdumpState.lastUpdate = now;
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/ajax_status")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            tcpdumpState.isUpdating = false;
            
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    updateUI(data);
                } catch(e) {
                    console.error('<%:更新状态时出错:%>', e);
                    showStatusError('<%:状态数据解析失败%>');
                }
            } else {
                console.error('<%:状态请求失败，状态码:%>', xhr.status);
                showStatusError('<%:状态请求失败 (HTTP %> ' + xhr.status + ')');
            }
        }
    };
    
    xhr.send();
}

function showStatusError(message) {
    var statusEl = document.getElementById('status-text');
    if (statusEl) {
        statusEl.innerHTML = '<%:错误:%> ' + message;
    }
}

// ------------------------------------------------
// UI 更新函数
// ------------------------------------------------
function updateUI(data) {
    var statusEl = document.getElementById('status-text');
    var currentFileSizeEl = document.getElementById('current-file-size');
    var fileSizeDisplayEl = document.getElementById('file-size-display');
    var startBtn = document.getElementById('btn-start');
    var stopBtn = document.getElementById('btn-stop');
    var downloadBtn = document.getElementById('btn-download');
    var deleteBtn = document.getElementById('btn-delete');
    
    if (!statusEl) return;
    
    var isRunning = data.running === true;
    var fileExists = data.file_exists === true;
    var fileSize = data.file_size || 0;
    var fileSizeHuman = data.file_size_human || formatFileSize(fileSize);
    
    if (isRunning) {
        statusEl.textContent = '<%:运行中%>' + (data.pid ? ' (PID: ' + data.pid + ')' : '');
    } else {
        statusEl.textContent = '<%:已停止%>';
    }
    
    if (fileExists) {
        fileSizeDisplayEl.style.display = 'block';
        currentFileSizeEl.textContent = fileSizeHuman;
    } else {
        fileSizeDisplayEl.style.display = 'none';
    }
    
    if (startBtn) startBtn.disabled = isRunning;
    if (stopBtn) stopBtn.disabled = !isRunning;
    if (downloadBtn) downloadBtn.disabled = !fileExists || isRunning;
    if (deleteBtn) deleteBtn.disabled = !fileExists || isRunning;
}

// ------------------------------------------------
// 操作函数
// ------------------------------------------------
function startCapture() {
    var interface = document.getElementById('interface').value;
    var filter = document.getElementById('filter').value;
    var filesize = document.getElementById('filesize').value;
    
    if (!interface) {
        alert('<%:请选择网络接口%>');
        return;
    }
    
    var startBtn = document.getElementById('btn-start');
    if (startBtn) {
        startBtn.disabled = true;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/start")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            setTimeout(updateStatus, 1000);
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (!result.success) {
                        alert('<%:启动失败:%> ' + (result.message || '<%:未知错误%>'));
                    }
                } catch(e) {
                    console.error('<%:解析启动响应时出错:%>', e);
                }
            } else {
                alert('<%:启动请求失败: %>' + xhr.status);
            }
        }
    };
    
    var params = 'interface=' + encodeURIComponent(interface) + 
                 '&filter=' + encodeURIComponent(filter) + 
                 '&filesize=' + encodeURIComponent(filesize);
    xhr.send(params);
}

function stopCapture() {
    var stopBtn = document.getElementById('btn-stop');
    if (stopBtn) {
        stopBtn.disabled = true;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/stop")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            setTimeout(updateStatus, 1000);
        }
    };
    
    xhr.send();
}

function downloadCapture() {
    window.open('<%=url("admin/services/tcpdump/download")%>', '_blank');
}

function deleteCapture() {
    if (!confirm('<%:您确定要删除 /tmp/tcpdump.pcap 文件吗？此操作无法撤销。%>')) {
        return;
    }

    var deleteBtn = document.getElementById('btn-delete');
    if (deleteBtn) {
        deleteBtn.disabled = true;
    }

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/delete")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            setTimeout(updateStatus, 500);
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (!result.success) {
                        alert(result.message || '<%:删除失败%>');
                    }
                } catch(e) {
                    console.error('<%:删除响应解析失败%>', e);
                }
            } else {
                alert('<%:删除请求失败: %>' + xhr.status);
            }
        }
    };
    
    xhr.send();
}

function refreshInterfaces() {
    var refreshBtn = document.getElementById('btn-refresh');
    if (refreshBtn) {
        refreshBtn.disabled = true;
    }
    
    loadInterfaces();
    
    setTimeout(function() {
        if (refreshBtn) {
            refreshBtn.disabled = false;
        }
    }, 1000);
}

// ------------------------------------------------
// 初始化
// ------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    setupPortSelector();
    loadInterfaces();
    updateStatus();
    
    var filesizeInput = document.getElementById('filesize');
    if (filesizeInput) {
        filesizeInput.addEventListener('change', function() {
            var value = parseInt(this.value);
            if (value < 1) this.value = '';
            if (value > 100) this.value = 100;
        });
    }
    
    setInterval(updateStatus, tcpdumpState.updateInterval);
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            updateStatus();
        }
    });
});

//]]>
</script>

<%+footer%>
