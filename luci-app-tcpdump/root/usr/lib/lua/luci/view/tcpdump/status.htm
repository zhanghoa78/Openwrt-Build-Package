<%+header%>

<style type="text/css">
	/* 固定大小的操作按钮 */
	.cbi-button-small {
		font-size: 13px !important;
		padding: 6px 12px !important;
		margin-right: 6px !important;
		margin-bottom: 4px;
		height: 32px !important;
		min-width: 90px !important;
		line-height: 20px !important;
		box-sizing: border-box !important;
		transition: all 0.2s ease !important;
		text-align: center !important;
		display: inline-flex !important;
		align-items: center !important;
		justify-content: center !important;
		vertical-align: middle !important;
	}
	.cbi-button-small:last-child {
		margin-right: 0 !important;
	}
	
	/* 按钮禁用状态 - 保持相同大小 */
	.cbi-button-small:disabled {
		opacity: 0.6 !important;
		cursor: not-allowed !important;
		min-width: 90px !important;
		height: 32px !important;
		padding: 6px 12px !important;
		transform: none !important;
	}
	
	/* 按钮悬停效果 */
	.cbi-button-small:not(:disabled):hover {
		transform: translateY(-1px) !important;
		box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
	}
	
	/* 按钮激活状态 */
	.cbi-button-small:not(:disabled):active {
		transform: translateY(0) !important;
		box-shadow: 0 1px 2px rgba(0,0,0,0.2) !important;
	}
	
	/* 按钮组优化 */
	.button-group {
		display: flex;
		flex-wrap: wrap;
		gap: 6px;
		align-items: center;
	}
	
	/* 状态指示器增强 */
	.status-indicator {
		padding: 6px 12px;
		border-radius: 4px;
		font-size: 14px;
		font-weight: bold;
		display: inline-block;
		min-width: 120px;
		text-align: center;
	}
	.status-running {
		color: #155724;
		background: #d4edda;
		border: 1px solid #c3e6cb;
	}
	.status-stopped {
		color: #721c24;
		background: #f8d7da;
		border: 1px solid #f5c6cb;
	}
	.status-loading {
		color: #856404;
		background: #fff3cd;
		border: 1px solid #ffeaa7;
	}
	
	/* 文件信息样式 */
	.file-info {
		font-size: 0.9em;
		color: #666;
	}
	.file-info.exists {
		color: #28a745;
	}
	.file-info.not-exists {
		color: #6c757d;
		font-style: italic;
	}
	
	/* 过滤器并排布局 */
	.filter-row {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-bottom: 10px;
		flex-wrap: wrap;
	}
	.filter-row .cbi-input-select {
		width: 180px;
		min-width: 150px;
	}
	.filter-row .cbi-input-text {
		width: 280px;
		min-width: 200px;
	}
	
	/* 自定义端口输入框 */
	.custom-port-input {
		display: none;
		margin-top: 5px;
	}
	.custom-port-input.active {
		display: block;
	}
	
	/* 接口并排布局 */
	.interface-row {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-bottom: 10px;
		flex-wrap: wrap;
	}
	.interface-select {
		width: 200px;
		min-width: 180px;
	}
	
	/* 文件大小限制行 */
	.file-size-row {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-bottom: 10px;
		flex-wrap: wrap;
	}
	.file-size-container {
		display: flex;
		align-items: center;
		gap: 5px;
	}
	.file-size-input {
		width: 80px;
	}
	.file-size-display {
		font-size: 0.9em;
		color: #666;
		margin-left: 15px;
	}
	
	/* 自定义端口按钮 */
	.custom-port-buttons {
		display: flex;
		align-items: center;
		gap: 5px;
	}
	.custom-port-buttons .cbi-button-small {
		min-width: 70px !important;
	}
	
	/* 确保左右对齐 */
	.cbi-value-title {
		width: 150px;
		padding-right: 10px;
		text-align: right;
	}
	.cbi-value-field {
		width: calc(100% - 160px);
	}
	
	/* 响应式优化 */
	@media (max-width: 768px) {
		.cbi-value-field .button-group {
			flex-direction: column;
			align-items: flex-start;
		}
		.cbi-button-small {
			margin-right: 0 !important;
			width: 100%;
			min-width: auto !important;
			text-align: center;
		}
		.filter-row,
		.interface-row,
		.file-size-row {
			flex-direction: column;
			align-items: flex-start;
			gap: 5px;
		}
		.filter-row .cbi-input-select,
		.filter-row .cbi-input-text,
		.interface-select {
			width: 100%;
		}
		.file-size-input {
			width: 100%;
		}
		.cbi-value-title,
		.cbi-value-field {
			width: 100%;
			text-align: left;
		}
	}
</style>

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 数据包捕获网页界面。捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<div class="interface-row">
					<select id="interface" class="cbi-input-select interface-select">
						<option value=""><%:正在加载接口...%></option>
					</select>
					<button id="btn-refresh" class="cbi-button cbi-button-reload cbi-button-small" onclick="refreshInterfaces()">
						<%:刷新接口%>
					</button>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络数据过滤器%></label>
			<div class="cbi-value-field">
				<div class="filter-row">
					<select id="port-preset" class="cbi-input-select">
						<option value=""><%:选择端口...%></option>
						<option value="port 80">80 (HTTP)</option>
						<option value="port 443">443 (HTTPS)</option>
						<option value="port 53">53 (DNS)</option>
						<option value="port 67">67 (DHCP)</option>
						<option value="port 68">68 (DHCP)</option>
						<option value="port 22">22 (SSH)</option>
						<option value="custom"><%:自定义端口...%></option>
					</select>
					<input type="text" id="filter" class="cbi-input-text" placeholder="自定义 BPF 过滤器，例如: host 192.168.1.1 or icmp" />
				</div>
				
				<!-- 自定义端口输入框 -->
				<div id="custom-port-container" class="custom-port-input">
					<div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
						<input type="number" id="custom-port" class="cbi-input-text" placeholder="输入端口号" min="1" max="65535" style="width: 120px;" />
						<div class="custom-port-buttons">
							<button id="btn-apply-custom-port" class="cbi-button cbi-button-apply cbi-button-small">
								<%:应用%>
							</button>
							<button id="btn-cancel-custom-port" class="cbi-button cbi-button-reset cbi-button-small">
								<%:取消%>
							</button>
						</div>
					</div>
				</div>
				
				<div class="cbi-value-description">
					<%:使用 BPF 语法，留空捕获所有流量。可从左侧选择常用端口或右侧输入自定义过滤器。%>
				</div>
			</div>
		</div>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:文件大小限制 (MB)%></label>
			<div class="cbi-value-field">
				<div class="file-size-row">
					<div class="file-size-container">
						<input type="number" id="filesize" class="cbi-input-text file-size-input" placeholder="10" min="1" max="100" />
						<span>MB</span>
					</div>
					<div id="file-size-display" class="file-size-display" style="display: none;">
						<span>当前捕获文件大小: </span><span id="current-file-size">0 KB</span>
					</div>
				</div>
				<div class="cbi-value-description">
					<%:最大文件大小 (1-100MB)，留空表示无限制%>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:状态%></label>
			<div class="cbi-value-field">
				<div id="status-container">
					<span id="status-text" class="status-indicator status-loading">
						<%:加载中...%>
					</span>
				</div>
			</div>
		</div>

		<div class="cbi-value cbi-value-last">
			<label class="cbi-value-title"><%:操作%></label>
			<div class="cbi-value-field">
				<div class="button-group">
					<button id="btn-start" class="cbi-button cbi-button-apply cbi-button-small" onclick="startCapture()">
						<%:开始捕获%>
					</button>
					<button id="btn-stop" class="cbi-button cbi-button-reset cbi-button-small" onclick="stopCapture()" disabled>
						<%:停止捕获%>
					</button>
					<button id="btn-download" class="cbi-button cbi-button-download cbi-button-small" onclick="downloadCapture()" disabled>
						<%:下载文件%>
					</button>
					<button id="btn-delete" class="cbi-button cbi-button-remove cbi-button-small" onclick="deleteCapture()" disabled>
						<%:删除文件%>
					</button>
				</div>
			</div>
		</div>
	</fieldset>
</div>

<script type="text/javascript">
//<![CDATA[

// ------------------------------------------------
// 全局状态和配置
// ------------------------------------------------
var tcpdumpState = {
    isUpdating: false,
    lastUpdate: 0,
    updateInterval: 3000
};

// ------------------------------------------------
// 工具函数
// ------------------------------------------------
function formatFileSize(bytes) {
    if (bytes === 0 || !bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ------------------------------------------------
// 端口选择器逻辑
// ------------------------------------------------
function setupPortSelector() {
    var portPreset = document.getElementById('port-preset');
    var filterInput = document.getElementById('filter');
    var customPortContainer = document.getElementById('custom-port-container');
    var customPortInput = document.getElementById('custom-port');
    var applyCustomPortBtn = document.getElementById('btn-apply-custom-port');
    var cancelCustomPortBtn = document.getElementById('btn-cancel-custom-port');
    
    if (portPreset && filterInput) {
        portPreset.addEventListener('change', function() {
            if (this.value === 'custom') {
                // 显示自定义端口输入框
                customPortContainer.classList.add('active');
                customPortInput.focus();
            } else if (this.value) {
                // 设置过滤器并隐藏自定义端口输入框
                filterInput.value = this.value;
                customPortContainer.classList.remove('active');
                customPortInput.value = '';
            } else {
                // 清空过滤器并隐藏自定义端口输入框
                filterInput.value = '';
                customPortContainer.classList.remove('active');
                customPortInput.value = '';
            }
        });
        
        // 应用自定义端口
        applyCustomPortBtn.addEventListener('click', function() {
            var port = customPortInput.value.trim();
            if (port && !isNaN(port) && port > 0 && port <= 65535) {
                filterInput.value = 'port ' + port;
                customPortContainer.classList.remove('active');
                customPortInput.value = '';
                portPreset.value = '';
            } else {
                alert('<%:请输入有效的端口号 (1-65535)%>');
            }
        });
        
        // 取消自定义端口
        cancelCustomPortBtn.addEventListener('click', function() {
            customPortContainer.classList.remove('active');
            customPortInput.value = '';
            portPreset.value = '';
        });
        
        // 自定义端口输入框回车键支持
        customPortInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                applyCustomPortBtn.click();
            }
        });
        
        // 过滤器输入时清除端口选择
        filterInput.addEventListener('input', function() {
            if (this.value !== portPreset.value) {
                portPreset.value = '';
                customPortContainer.classList.remove('active');
                customPortInput.value = '';
            }
        });
        
        // 输入框获得焦点时选择所有文本
        filterInput.addEventListener('focus', function() {
            this.select();
        });
    }
}

// ------------------------------------------------
// 接口管理
// ------------------------------------------------
function loadInterfaces() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/interfaces")%>', true);
    xhr.timeout = 10000; // 10秒超时
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var select = document.getElementById('interface');
            
            if (xhr.status === 200) {
                try {
                    var interfaces = JSON.parse(xhr.responseText);
                    
                    if (!interfaces || interfaces.length === 0) {
                        select.innerHTML = '<option value=""><%:未找到网络接口%></option>';
                        return;
                    }
                    
                    select.innerHTML = '';
                    var brLanExists = interfaces.includes('br-lan');
                    var defaultSelected = false;
                    
                    interfaces.forEach(function(iface) {
                        var option = document.createElement('option');
                        option.value = iface;
                        
                        if (iface === 'br-lan') {
                            option.textContent = 'br-lan (<%:默认%>)';
                            option.selected = true;
                            defaultSelected = true;
                        } else {
                            option.textContent = iface;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    // 如果没有br-lan，选择第一个接口
                    if (!brLanExists && interfaces.length > 0) {
                        select.firstChild.selected = true;
                    }
                    
                } catch(e) {
                    console.error('<%:加载接口时出错 (JSON解析失败)%>:', e);
                    select.innerHTML = '<option value=""><%:加载接口失败%></option>';
                }
            } else {
                console.error('<%:加载接口失败，状态码:%>', xhr.status);
                select.innerHTML = '<option value=""><%:加载接口失败 (HTTP %> ' + xhr.status + ')</option>';
            }
        }
    };
    
    xhr.ontimeout = function() {
        console.error('<%:加载接口请求超时%>');
    };
    
    xhr.send();
}

// ------------------------------------------------
// 状态管理
// ------------------------------------------------
function updateStatus() {
    // 防止重复请求
    if (tcpdumpState.isUpdating) return;
    
    var now = Date.now();
    if (now - tcpdumpState.lastUpdate < 1000) return; // 最少1秒间隔
    
    tcpdumpState.isUpdating = true;
    tcpdumpState.lastUpdate = now;
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/ajax_status")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            tcpdumpState.isUpdating = false;
            
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    updateUI(data);
                } catch(e) {
                    console.error('<%:更新状态时出错:%>', e);
                    showStatusError('<%:状态数据解析失败%>');
                }
            } else {
                console.error('<%:状态请求失败，状态码:%>', xhr.status);
                showStatusError('<%:状态请求失败 (HTTP %> ' + xhr.status + ')');
            }
        }
    };
    
    xhr.send();
}

function showStatusError(message) {
    var statusEl = document.getElementById('status-text');
    if (statusEl) {
        statusEl.className = 'status-indicator status-loading';
        statusEl.innerHTML = '<%:错误:%> ' + message;
    }
}

// ------------------------------------------------
// UI 更新函数
// ------------------------------------------------
function updateUI(data) {
    var statusEl = document.getElementById('status-text');
    var currentFileSizeEl = document.getElementById('current-file-size');
    var fileSizeDisplayEl = document.getElementById('file-size-display');
    var startBtn = document.getElementById('btn-start');
    var stopBtn = document.getElementById('btn-stop');
    var downloadBtn = document.getElementById('btn-download');
    var deleteBtn = document.getElementById('btn-delete');
    
    if (!statusEl) return;
    
    var isRunning = data.running === true;
    var fileExists = data.file_exists === true;
    var fileSize = data.file_size || 0;
    var fileSizeHuman = data.file_size_human || formatFileSize(fileSize);
    
    // 更新状态显示
    if (isRunning) {
        statusEl.className = 'status-indicator status-running';
        statusEl.textContent = '<%:运行中%>' + (data.pid ? ' (PID: ' + data.pid + ')' : '');
    } else {
        statusEl.className = 'status-indicator status-stopped';
        statusEl.textContent = '<%:已停止%>';
    }
    
    // 更新文件大小显示
    if (fileExists) {
        fileSizeDisplayEl.style.display = 'block';
        currentFileSizeEl.textContent = fileSizeHuman;
    } else {
        fileSizeDisplayEl.style.display = 'none';
    }
    
    // 更新按钮状态
    if (startBtn) startBtn.disabled = isRunning;
    if (stopBtn) stopBtn.disabled = !isRunning;
    if (downloadBtn) downloadBtn.disabled = !fileExists || isRunning;
    if (deleteBtn) deleteBtn.disabled = !fileExists || isRunning;
}

// ------------------------------------------------
// 操作函数
// ------------------------------------------------
function startCapture() {
    var interface = document.getElementById('interface').value;
    var filter = document.getElementById('filter').value;
    var filesize = document.getElementById('filesize').value;
    
    if (!interface) {
        alert('<%:请选择网络接口%>');
        return;
    }
    
    var startBtn = document.getElementById('btn-start');
    if (startBtn) {
        startBtn.disabled = true;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/start")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            // 无论成功与否，都更新状态
            setTimeout(updateStatus, 1000);
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (!result.success) {
                        alert('<%:启动失败:%> ' + (result.message || '<%:未知错误%>'));
                    }
                } catch(e) {
                    console.error('<%:解析启动响应时出错:%>', e);
                }
            } else {
                alert('<%:启动请求失败: %>' + xhr.status);
            }
        }
    };
    
    var params = 'interface=' + encodeURIComponent(interface) + 
                 '&filter=' + encodeURIComponent(filter) + 
                 '&filesize=' + encodeURIComponent(filesize);
    xhr.send(params);
}

function stopCapture() {
    var stopBtn = document.getElementById('btn-stop');
    if (stopBtn) {
        stopBtn.disabled = true;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/stop")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            setTimeout(updateStatus, 1000);
        }
    };
    
    xhr.send();
}

function downloadCapture() {
    window.open('<%=url("admin/services/tcpdump/download")%>', '_blank');
}

function deleteCapture() {
    if (!confirm('<%:您确定要删除 /tmp/tcpdump.pcap 文件吗？此操作无法撤销。%>')) {
        return;
    }

    var deleteBtn = document.getElementById('btn-delete');
    if (deleteBtn) {
        deleteBtn.disabled = true;
    }

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/delete")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            // 更新状态
            setTimeout(updateStatus, 500);
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (!result.success) {
                        alert(result.message || '<%:删除失败%>');
                    }
                } catch(e) {
                    console.error('<%:删除响应解析失败%>', e);
                }
            } else {
                alert('<%:删除请求失败: %>' + xhr.status);
            }
        }
    };
    
    xhr.send();
}

function refreshInterfaces() {
    var refreshBtn = document.getElementById('btn-refresh');
    if (refreshBtn) {
        refreshBtn.disabled = true;
    }
    
    loadInterfaces();
    
    setTimeout(function() {
        if (refreshBtn) {
            refreshBtn.disabled = false;
        }
    }, 1000);
}

// ------------------------------------------------
// 初始化
// ------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    // 设置端口选择器
    setupPortSelector();
    
    // 加载接口和初始状态
    loadInterfaces();
    updateStatus();
    
    // 文件大小输入验证
    var filesizeInput = document.getElementById('filesize');
    if (filesizeInput) {
        filesizeInput.addEventListener('change', function() {
            var value = parseInt(this.value);
            if (value < 1) this.value = '';
            if (value > 100) this.value = 100;
        });
    }
    
    // 定期状态更新
    setInterval(updateStatus, tcpdumpState.updateInterval);
    
    // 页面可见性改变时更新状态
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            updateStatus();
        }
    });
});

//]]>
</script>

<%+footer%>
