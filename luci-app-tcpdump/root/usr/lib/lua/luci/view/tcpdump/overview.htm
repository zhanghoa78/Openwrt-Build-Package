<%+header%>

<!-- 移除外部 CSS 引入 -->

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 数据包捕获网页界面。%><br>
		<%:捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<div style="display: flex; align-items: center; gap: 10px;"> <!-- 使用Flexbox保持水平排列 -->
					<select id="interface" class="cbi-input-select" style="flex-grow: 1;">
						<option value=""><%:正在加载接口...%></option>
					</select>
					<button id="btn-refresh" class="cbi-button" onclick="refreshInterfaces()">
						<%:刷新接口%>
					</button>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络数据过滤器%></label>
			<div class="cbi-value-field">
				<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
					<input type="text" id="filter" class="cbi-input-text" style="flex-grow: 1;"
						   placeholder="输入 BPF 过滤器，例如: port 80 or port 443" />
					<button type="button" class="cbi-button" onclick="showAdvancedFilterDialog()">
						<%:高级过滤器%>
					</button>
				</div>
				
				<div class="cbi-value-description"><%:快速选择端口:%></div>
				<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; margin-bottom: 10px;">
					<!-- 组合端口选择按钮 -->
					<button type="button" class="cbi-button cbi-button-action filter-preset-group-btn" data-group="web">Web (HTTP/S)</button>
					<button type="button" class="cbi-button cbi-button-action filter-preset-group-btn" data-group="dhcp">DHCP (S/C)</button>
					<button type="button" class="cbi-button cbi-button-action filter-preset-group-btn" data-group="dns">DNS</button>
					<!-- 如果需要，可以保留或添加其他独立的常用端口 -->
					<button type="button" class="cbi-button cbi-button-action filter-preset-btn" data-port="22">SSH</button>
					<button type="button" class="cbi-button cbi-button-action filter-preset-btn" data-port="123">NTP</button>
				</div>
				
				<div class="cbi-value-description">
					<%:使用 BPF 语法，支持多个端口: port 80 or port 443。%><br>
					<%:留空捕获所有流量。%>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:包数量限制%></label>
			<div class="cbi-value-field">
				<input type="number" id="count" class="cbi-input-text" placeholder="1000" min="1" max="100000" />
				<div class="cbi-value-description">
					<%:捕获指定数量的包后自动停止，留空表示无限制%>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:状态%></label>
			<div class="cbi-value-field">
				<div style="display: flex; align-items: center; flex-wrap: wrap;"> <!-- flex-wrap 以防内容过多挤压 -->
					<span id="status-text" class="cbi-value-description status-indicator-general">
						<%:加载中...%>
					</span>
					<span id="interface-info" class="cbi-value-description" style="display: none; margin-left: 10px;"></span>
					<span id="file-size-info" class="cbi-value-description" style="display: none; margin-left: 10px;"></span> 
                    <!-- 新增文件大小显示元素 -->
				</div>
			</div>
		</div>

		<div class="cbi-value cbi-value-last">
			<label class="cbi-value-title"><%:操作%></label>
			<div class="cbi-value-field">
				<div class="cbi-button-group"> <!-- 使用cbi-button-group可能提供更好的样式 -->
					<button id="btn-start" class="cbi-button cbi-button-apply" onclick="startCapture()">
						<%:开始捕获%>
					</button>
					<button id="btn-stop" class="cbi-button cbi-button-reset" onclick="stopCapture()" disabled>
						<%:停止捕获%>
					</button>
					<button id="btn-download" class="cbi-button cbi-button-action" onclick="downloadCapture()" disabled>
						<%:下载文件%>
					</button>
					<button id="btn-delete" class="cbi-button cbi-button-negative" onclick="deleteCapture()" disabled>
						<%:删除文件%>
					</button>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:使用提示%></legend>
		<div class="cbi-section-descr">
			<ul class="cbi-value-description"> <!-- 调整为使用cbi-value-description包装列表 -->
				<li><%:快捷键: Ctrl+Enter 开始捕获, Ctrl+Esc 停止捕获%></li>
				<li><%:点击端口按钮快速添加过滤器%></li>
				<li><%:文件保存在 /tmp/tcpdump.pcap，重启后会丢失%></li>
				<li><%:使用 Wireshark 或 tcpdump 命令分析下载的 .pcap 文件%></li>
			</ul>
		</div>
	</fieldset>
</div>

<script type="text/javascript">
//<![CDATA[

// ------------------------------------------------
// 全局状态和配置
// ------------------------------------------------
var tcpdumpState = {
    isUpdating: false,
    lastUpdate: 0,
    updateInterval: 3000
};

// ------------------------------------------------
// 工具函数
// ------------------------------------------------
function formatFileSize(bytes) {
    if (bytes === 0 || !bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ------------------------------------------------
// 通知系统 (根据OpenWrt默认样式进行微调)
// ------------------------------------------------
function showNotification(message, type) {
    var existingNotice = document.querySelector('.tcpdump-notice');
    if (existingNotice) {
        existingNotice.remove();
    }
    
    var notice = document.createElement('div');
    notice.className = 'tcpdump-notice alert-message ' + 
        (type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
    
    notice.innerHTML = '<p>' + message + '</p>';
    notice.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        min-width: 300px;
        max-width: 500px;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease forwards;
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    
    document.body.appendChild(notice);
    
    setTimeout(function() {
        if (notice.parentNode) {
            notice.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(function() {
                if (notice.parentNode) {
                    notice.remove();
                }
            }, 300);
        }
    }, 5000);
}

// ------------------------------------------------
// 端口选择器逻辑 (大幅修改以支持组合按钮)
// ------------------------------------------------
function setupPortSelector() {
    var filterInput = document.getElementById('filter');
    
    // 定义端口组及其对应的端口
    var portGroups = {
        'web': ['80', '443'],
        'dhcp': ['67', '68'],
        'dns': ['53']
    };

    // 获取所有独立端口按钮 (如 SSH, NTP)
    var singlePortButtons = document.querySelectorAll('.filter-preset-btn');
    // 获取所有组合端口按钮
    var groupPortButtons = document.querySelectorAll('.filter-preset-group-btn');
    
    var currentFilterPorts = new Set();

    function parseFilterInput() {
        currentFilterPorts.clear();
        var filterValue = filterInput.value.trim();
        if (filterValue) {
            var matches = filterValue.matchAll(/port\s+(\d+)\b/g); 
            for (const match of matches) {
                currentFilterPorts.add(match[1]);
            }
        }
    }

    function updateFilterInput() {
        var portsArray = Array.from(currentFilterPorts);
        if (portsArray.length > 0) {
            portsArray.sort((a,b) => parseInt(a) - parseInt(b));
            filterInput.value = 'port ' + portsArray.join(' or port ');
        } else {
            filterInput.value = '';
        }
        filterInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function updatePresetButtons() {
        parseFilterInput();
        
        singlePortButtons.forEach(function(button) {
            var port = button.dataset.port;
            if (currentFilterPorts.has(port)) {
                button.classList.add('active', 'cbi-button-highlight');
            } else {
                button.classList.remove('active', 'cbi-button-highlight');
            }
        });

        groupPortButtons.forEach(function(button) {
            var groupKey = button.dataset.group;
            var portsInGroup = portGroups[groupKey];
            
            var allPortsInGroupSelected = portsInGroup.every(p => currentFilterPorts.has(p));

            if (allPortsInGroupSelected) {
                button.classList.add('active', 'cbi-button-highlight');
            } else {
                button.classList.remove('active', 'cbi-button-highlight');
            }
        });
    }

    singlePortButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            var port = this.dataset.port;
            if (currentFilterPorts.has(port)) {
                currentFilterPorts.delete(port);
            } else {
                currentFilterPorts.add(port);
            }
            updateFilterInput();
            updatePresetButtons();
        });
    });

    groupPortButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            var groupKey = this.dataset.group;
            var portsInGroup = portGroups[groupKey];
            
            var allPortsSelected = portsInGroup.every(p => currentFilterPorts.has(p));
            
            if (allPortsSelected) {
                portsInGroup.forEach(p => currentFilterPorts.delete(p));
            } else {
                portsInGroup.forEach(p => currentFilterPorts.delete(p));
                portsInGroup.forEach(p => currentFilterPorts.add(p));
            }
            updateFilterInput();
            updatePresetButtons();
        });
    });

    filterInput.addEventListener('input', updatePresetButtons);
    
    updatePresetButtons();

    filterInput.addEventListener('focus', function() {
        this.select();
    });
}
// ------------------------------------------------
// 高级过滤器构建器 (样式调整以适应基本主题)
// ------------------------------------------------
function showAdvancedFilterDialog() {
    var filterInput = document.getElementById('filter');
    
    var dialogHtml = `
        <div class="advanced-filter-dialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div class="cbi-map" style="background: white; padding: 20px; border-radius: 8px; width: 500px; max-width: 90%;">
                <h3><%:高级过滤器构建器%></h3>
                <div class="cbi-value">
                    <label class="cbi-value-title"><%:主机/IP地址:%></label>
                    <div class="cbi-value-field">
                        <input type="text" id="adv-host" class="cbi-input-text" style="width: 100%;" placeholder="例如: 192.168.1.1 或 host example.com">
                    </div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title"><%:协议:%></label>
                    <div class="cbi-value-field">
                        <select id="adv-protocol" class="cbi-input-select" style="width: 100%;">
                            <option value=""><%:所有协议%></option>
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                            <option value="icmp">ICMP</option>
                            <option value="arp">ARP</option>
                        </select>
                    </div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title"><%:端口:%></label>
                    <div class="cbi-value-field">
                        <input type="text" id="adv-port" class="cbi-input-text" style="width: 100%;" placeholder="例如: 80, 443, 或 1-1024">
                    </div>
                </div>
                <div class="cbi-value cbi-value-last">
                    <label class="cbi-value-title"><%:网络段:%></label>
                    <div class="cbi-value-field">
                        <input type="text" id="adv-network" class="cbi-input-text" style="width: 100%;" placeholder="例如: 192.168.1.0/24">
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="cbi-button" onclick="closeAdvancedFilter()"><%:取消%></button>
                    <button type="button" class="cbi-button cbi-button-apply" onclick="applyAdvancedFilter()"><%:应用%></button>
                </div>
            </div>
        </div>
    `;
    
    var dialog = document.createElement('div');
    dialog.innerHTML = dialogHtml;
    document.body.appendChild(dialog);
    
    window.closeAdvancedFilter = function() {
        dialog.remove();
    };
    
    window.applyAdvancedFilter = function() {
        var host = document.getElementById('adv-host').value;
        var protocol = document.getElementById('adv-protocol').value;
        var port = document.getElementById('adv-port').value;
        var network = document.getElementById('adv-network').value;
        
        var filterParts = [];
        
        if (host) {
            filterParts.push('host ' + host);
        }
        
        if (protocol) {
            filterParts.push(protocol);
        }
        
        if (port) {
            if (port.includes('-')) {
                filterParts.push('portrange ' + port);
            } else if (port.includes(',')) {
                var ports = port.split(',').map(p => 'port ' + p.trim()).join(' or ');
                filterParts.push('(' + ports + ')');
            } else {
                filterParts.push('port ' + port);
            }
        }
        
        if (network) {
            filterParts.push('net ' + network);
        }
        
        var finalFilter = filterParts.join(' and ');
        filterInput.value = finalFilter;
        filterInput.dispatchEvent(new Event('input', { bubbles: true }));
        dialog.remove();
    };
}

// ------------------------------------------------
// 接口管理
// ------------------------------------------------
function loadInterfaces() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/interfaces")%>', true);
    xhr.timeout = 10000;
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var select = document.getElementById('interface');
            
            if (xhr.status === 200) {
                try {
                    var interfaces = JSON.parse(xhr.responseText);
                    
                    if (!interfaces || interfaces.length === 0) {
                        select.innerHTML = '<option value=""><%:未找到网络接口%></option>';
                        return;
                    }
                    
                    select.innerHTML = '';
                    var brLanExists = interfaces.includes('br-lan');
                    
                    interfaces.forEach(function(iface) {
                        var option = document.createElement('option');
                        option.value = iface;
                        
                        if (iface === 'br-lan') {
                            option.textContent = 'br-lan (<%:默认%>)';
                        } else {
                            option.textContent = iface;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    if (brLanExists) {
                        select.value = 'br-lan';
                    } else if (interfaces.length > 0) {
                        select.value = interfaces[0];
                    }
                    
                } catch(e) {
                    console.error('<%:加载接口时出错 (JSON解析失败)%>:', e);
                    select.innerHTML = '<option value=""><%:加载接口失败%></option>';
                }
            } else {
                console.error('<%:加载接口失败，状态码:%>', xhr.status);
                select.innerHTML = '<option value=""><%:加载接口失败 (HTTP %> ' + xhr.status + ')</option>';
            }
        }
    };
    
    xhr.ontimeout = function() {
        console.error('<%:加载接口请求超时%>');
    };
    
    xhr.send();
}

// ------------------------------------------------
// 输入验证
// ------------------------------------------------
function validateInputs() {
    var interfaceVal = document.getElementById('interface');
    var selectedInterface = interfaceVal.value;
    
    var filter = document.getElementById('filter').value;
    var count = document.getElementById('count').value;
    
    var errors = [];
    
    if (!selectedInterface || selectedInterface === "") {
        errors.push('<%:请选择网络接口%>');
    }
    
    if (filter) {
        var dangerousChars = /[;&|`$\\]/;
        if (dangerousChars.test(filter)) {
            errors.push('<%:过滤器中包含不安全的字符%>');
        }
    }
    
    if (count) {
        var packetCount = parseInt(count);
        if (isNaN(packetCount) || packetCount < 1 || packetCount > 100000) {
            errors.push('<%:包数量必须在 1-100000 之间%>');
        }
    }
    
    return errors;
}

// ------------------------------------------------
// 状态管理
// ------------------------------------------------
function updateStatus() {
    if (tcpdumpState.isUpdating) return;
    
    var now = Date.now();
    if (now - tcpdumpState.lastUpdate < 1000) return;
    
    tcpdumpState.isUpdating = true;
    tcpdumpState.lastUpdate = now;
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/ajax_status")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            tcpdumpState.isUpdating = false;
            
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    updateUI(data);
                } catch(e) {
                    console.error('<%:更新状态时出错:%>', e);
                    showStatusError('<%:状态数据解析失败%>');
                }
            } else {
                console.error('<%:状态请求失败，状态码:%>', xhr.status);
                showStatusError('<%:状态请求失败 (HTTP %> ' + xhr.status + ')');
            }
        }
    };
    
    xhr.send();
}

function showStatusError(message) {
    var statusEl = document.getElementById('status-text');
    if (statusEl) {
        statusEl.className = 'cbi-value-description status-indicator-general error';
        statusEl.innerHTML = '<%:错误:%> ' + message;
    }
}

// ------------------------------------------------
// UI 更新函数 (新增文件大小显示逻辑)
// ------------------------------------------------
function updateUI(data) {
    var statusEl = document.getElementById('status-text');
    var interfaceInfoEl = document.getElementById('interface-info');
    var fileSizeInfoEl = document.getElementById('file-size-info'); // 获取文件大小显示元素
    var startBtn = document.getElementById('btn-start');
    var stopBtn = document.getElementById('btn-stop');
    var downloadBtn = document.getElementById('btn-download');
    var deleteBtn = document.getElementById('btn-delete');
    
    if (!statusEl) return;
    
    var isRunning = data.running === true;
    var fileExists = data.file_exists === true;
    var fileSize = data.file_size || 0; // 获取文件大小，如果不存在则默认为0
    
    if (isRunning) {
        statusEl.className = 'cbi-value-description status-indicator-general success';
        var statusText = '<%:运行中%>';
        if (data.pid) statusText += ' (PID: ' + data.pid + ')';
        statusEl.textContent = statusText;
        
        if (data.interface) {
            interfaceInfoEl.style.display = 'inline';
            interfaceInfoEl.textContent = '接口: ' + data.interface;
        } else {
            interfaceInfoEl.style.display = 'none';
        }

        // 正在运行中，显示文件大小
        if (fileExists) {
            fileSizeInfoEl.style.display = 'inline';
            fileSizeInfoEl.textContent = '文件大小: ' + formatFileSize(fileSize);
        } else {
            fileSizeInfoEl.style.display = 'none';
        }

    } else {
        statusEl.className = 'cbi-value-description status-indicator-general';
        statusEl.textContent = '<%:已停止%>';
        interfaceInfoEl.style.display = 'none';

        // 停止后，如果文件存在，也显示文件大小
        if (fileExists) {
            fileSizeInfoEl.style.display = 'inline';
            fileSizeInfoEl.textContent = '文件大小: ' + formatFileSize(fileSize);
        } else {
            fileSizeInfoEl.style.display = 'none';
        }
    }
    
    if (startBtn) startBtn.disabled = isRunning;
    if (stopBtn) stopBtn.disabled = !isRunning;
    if (downloadBtn) downloadBtn.disabled = !fileExists || isRunning; 
    if (deleteBtn) deleteBtn.disabled = !fileExists || isRunning;
}

// ------------------------------------------------
// 操作函数 - 保持不变
// ------------------------------------------------
function startCapture() {
    var errors = validateInputs();
    if (errors.length > 0) {
        showNotification('<%:错误:%> ' + errors.join(', '), 'error');
        return;
    }
    
    var interface = document.getElementById('interface').value;
    var filter = document.getElementById('filter').value;
    var count = document.getElementById('count').value;
    
    var startBtn = document.getElementById('btn-start');
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.textContent = '<%:启动中...%>';
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/start")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.timeout = 15000;
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.textContent = '<%:开始捕获%>';
            }
            setTimeout(updateStatus, 1000); 
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        showNotification(result.message, 'success');
                    } else {
                        showNotification('<%:启动失败:%> ' + (result.message || '<%:未知错误%>'), 'error');
                    }
                } catch(e) {
                    showNotification('<%:响应解析失败%>', 'error');
                }
            } else {
                showNotification('<%:请求失败: HTTP %> ' + xhr.status, 'error');
            }
        }
    };
    
    xhr.ontimeout = function() {
        showNotification('<%:启动请求超时%>', 'error');
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.textContent = '<%:开始捕获%>';
        }
    };
    
    var params = 'interface=' + encodeURIComponent(interface) + 
                 '&filter=' + encodeURIComponent(filter) + 
                 '&count=' + encodeURIComponent(count);
    xhr.send(params);
}


function stopCapture() {
    var stopBtn = document.getElementById('btn-stop');
    var originalText = stopBtn ? stopBtn.textContent : '';
    
    if (stopBtn) {
        stopBtn.disabled = true;
        stopBtn.textContent = '<%:停止中...%>';
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/stop")%>', true);
    xhr.timeout = 15000;
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (stopBtn) {
                stopBtn.textContent = originalText;
            }
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        showNotification(result.message, 'success');
                        updateStatus(); 
                        setTimeout(updateStatus, 2000);
                    } else {
                        showNotification('<%:停止失败:%> ' + (result.message || '<%:未知错误%>'), 'error');
                        updateStatus();
                    }
                } catch(e) {
                    showNotification('<%:响应解析失败%>', 'error');
                    updateStatus();
                }
            } else {
                showNotification('<%:停止请求失败，状态码:%> ' + xhr.status, 'error');
                updateStatus();
            }
        }
    };
    
    xhr.ontimeout = function() {
        showNotification('<%:停止请求超时，但进程可能仍在停止中%>', 'warning');
        if (stopBtn) {
            stopBtn.textContent = originalText;
        }
        updateStatus();
    };
    
    xhr.send();
}

function downloadCapture() {
    var downloadBtn = document.getElementById('btn-download');
    if (downloadBtn) downloadBtn.disabled = true;

    window.open('<%=url("admin/services/tcpdump/download")%>', '_blank');
    
    setTimeout(function() {
        updateStatus(); 
    }, 2000); 
}

function deleteCapture() {
    if (!confirm('<%:您确定要删除 /tmp/tcpdump.pcap 文件吗？此操作无法撤销。%>')) {
        return;
    }

    var deleteBtn = document.getElementById('btn-delete');
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.textContent = '<%:删除中...%>';
    }

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/delete")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (deleteBtn) {
                deleteBtn.textContent = '<%:删除文件%>';
            }
            setTimeout(updateStatus, 500);
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        showNotification(result.message, 'success');
                    } else {
                        showNotification(result.message || '<%:删除失败%>', 'error');
                    }
                } catch(e) {
                    showNotification('<%:删除响应解析失败%>', 'error');
                }
            } else {
                showNotification('<%:删除请求失败:%> ' + xhr.status, 'error');
            }
        }
    };
    
    xhr.send();
}

function refreshInterfaces() {
    var refreshBtn = document.getElementById('btn-refresh');
    var originalText = refreshBtn ? refreshBtn.textContent : '';

    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = '<%:刷新中...%>';
    }
    
    loadInterfaces();
    
    setTimeout(function() {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.textContent = originalText;
        }
        updateStatus();
    }, 1500); 
}

// ------------------------------------------------
// 初始化
// ------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    setupPortSelector();
    loadInterfaces();
    updateStatus();
    
    var countInput = document.getElementById('count');
    if (countInput) {
        countInput.addEventListener('change', function() {
            var value = parseInt(this.value);
            if (isNaN(value) || value < 1) this.value = '';
            else if (value > 100000) this.value = 100000;
        });
    }
    
    setInterval(updateStatus, tcpdumpState.updateInterval);
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            updateStatus();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    document.getElementById('btn-start').click(); 
                    break;
                case 'Escape':
                    e.preventDefault();
                    document.getElementById('btn-stop').click();
                    break;
            }
        }
    });
});

//]]>
</script>

<%+footer%>
