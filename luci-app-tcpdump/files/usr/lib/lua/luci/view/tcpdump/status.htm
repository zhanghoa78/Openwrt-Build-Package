<%+header%>

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 网页界面。捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<select id="interface" class="cbi-input-select">
					<option value=""><%:加载中...%></option>
				</select>
				<button type="button" id="btn-refresh-interfaces" class="cbi-button cbi-button-action">
					<%:刷新接口%>
				</button>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:BPF 过滤器%></label>
			<div class="cbi-value-field">
				<input type="text" id="filter" class="cbi-input-text" placeholder="port 80" style="width: 300px;" />
				<div class="cbi-value-description">
					<%:示例: "port 80", "host 192.168.1.100", 留空则捕获所有流量%>
				</div>
			</div>
		</div>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:文件大小限制%></label>
			<div class="cbi-value-field">
				<div style="display: flex; align-items: center;">
					<input type="number" id="filesize" class="cbi-input-text" placeholder="10" min="1" max="1000" style="width: 80px; margin-right: 8px;" />
					<span style="color: #666;">MB</span>
				</div>
				<div class="cbi-value-description">
					<%:单个文件最大大小 (1-1000MB)，留空则不限制大小%>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:状态%></label>
			<div class="cbi-value-field">
				<span id="status-text" style="font-weight: bold; padding: 6px 12px; border-radius: 4px; font-size: 14px;">
					<%:加载中...%>
				</span>
			</div>
		</div>

		<div class="cbi-value cbi-value-last">
			<label class="cbi-value-title"><%:操作%></label>
			<div class="cbi-value-field">
				<button id="btn-start" class="cbi-button cbi-button-apply" onclick="startCapture()">
					<%:开始捕获%>
				</button>
				<button id="btn-stop" class="cbi-button cbi-button-reset" onclick="stopCapture()">
					<%:停止捕获%>
				</button>
			</div>
		</div>
	</fieldset>

	<div class="cbi-page-actions" style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
		<strong><%:使用说明:%></strong>
		<ul style="margin: 5px 0; padding-left: 20px;">
			<li><%:捕获文件位置: %> <code>/tmp/tcpdump.pcap</code> <%:(如果设置了大小限制，可能会有 .1, .2 等后缀)%></li>
			<li><%:使用 SCP 或 WinSCP 下载捕获文件%></li>
			<li><%:文件大小限制: 设置单个文件的最大大小，超过后会创建新文件%></li>
			<li><%:点击"刷新接口"按钮可以重新扫描网络接口%></li>
		</ul>
	</div>
</div>

<script type="text/javascript">
//<![CDATA[

// 全局状态变量
var tcpdumpState = {
    isRunning: false,
    currentPid: null,
    isProcessing: false
};

// 加载网络接口列表
function loadInterfaces() {
    var interfaceSelect = document.getElementById('interface');
    var refreshBtn = document.getElementById('btn-refresh-interfaces');
    
    if (refreshBtn) refreshBtn.disabled = true;
    interfaceSelect.innerHTML = '<option value=""><%:加载中...%></option>';
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/interfaces")%>?t=' + new Date().getTime(), true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var interfaces = JSON.parse(xhr.responseText);
                    interfaceSelect.innerHTML = '';
                    
                    if (interfaces.length > 0) {
                        // 添加默认选项
                        interfaceSelect.add(new Option('<%:请选择接口%>', ''));
                        
                        // 添加所有接口选项
                        interfaces.forEach(function(iface) {
                            interfaceSelect.add(new Option(iface, iface));
                        });
                        
                        // 默认选择第一个非空选项（如果有）
                        if (interfaces.length > 0) {
                            // 优先选择 br-lan，如果没有则选择第一个
                            var defaultInterface = interfaces.includes('br-lan') ? 'br-lan' : interfaces[0];
                            interfaceSelect.value = defaultInterface;
                        }
                    } else {
                        interfaceSelect.innerHTML = '<option value=""><%:未找到网络接口%></option>';
                    }
                } catch(e) {
                    console.error('解析接口列表错误:', e);
                    interfaceSelect.innerHTML = '<option value=""><%:加载失败%></option>';
                }
            } else {
                interfaceSelect.innerHTML = '<option value=""><%:加载失败%></option>';
            }
            
            if (refreshBtn) refreshBtn.disabled = false;
        }
    };
    xhr.send();
}

// 更新状态显示
function updateStatusDisplay() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/ajax_status")%>?t=' + new Date().getTime(), true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                updateUIState(data);
            } catch(e) {
                console.error('状态更新错误:', e);
            }
        }
    };
    xhr.send();
}

// 更新UI状态
function updateUIState(data) {
    var statusEl = document.getElementById('status-text');
    var startBtn = document.getElementById('btn-start');
    var stopBtn = document.getElementById('btn-stop');
    
    // 更新全局状态
    tcpdumpState.isRunning = data.running;
    tcpdumpState.currentPid = data.pid;
    
    if (data.running) {
        statusEl.innerHTML = '<span style="color: green; background: #e8f5e8; display: inline-block; padding: 6px 12px; border-radius: 4px; font-size: 14px;">' + 
            '<%:运行中%>' + (data.pid ? ' (PID: ' + data.pid + ')' : '') + '</span>';
        
        // 更新按钮状态
        if (startBtn) startBtn.disabled = true;
        if (stopBtn) stopBtn.disabled = false;
    } else {
        statusEl.innerHTML = '<span style="color: red; background: #fde8e8; display: inline-block; padding: 6px 12px; border-radius: 4px; font-size: 14px;"><%:已停止%></span>';
        
        // 更新按钮状态
        if (startBtn) startBtn.disabled = false;
        if (stopBtn) stopBtn.disabled = true;
    }
    
    // 重置处理状态
    tcpdumpState.isProcessing = false;
}

// 开始抓包
function startCapture() {
    // 防止重复点击
    if (tcpdumpState.isProcessing) return;
    tcpdumpState.isProcessing = true;
    
    var interface = document.getElementById('interface').value || '';
    var filter = document.getElementById('filter').value || '';
    var filesize = document.getElementById('filesize').value || '';
    var startBtn = document.getElementById('btn-start');
    
    // 验证接口选择
    if (!interface) {
        alert('请选择网络接口');
        tcpdumpState.isProcessing = false;
        return;
    }
    
    // 验证文件大小
    if (filesize !== '') {
        var sizeNum = parseInt(filesize);
        if (isNaN(sizeNum) || sizeNum < 1 || sizeNum > 1000) {
            alert('文件大小必须为 1-1000 之间的数字');
            tcpdumpState.isProcessing = false;
            return;
        }
    }
    
    // 立即更新按钮状态
    if (startBtn) startBtn.disabled = true;
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/start")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        // 成功启动，等待状态更新
                        setTimeout(function() {
                            updateStatusDisplay();
                            setTimeout(updateStatusDisplay, 2000);
                        }, 2000);
                    } else {
                        // 启动失败，恢复按钮状态
                        tcpdumpState.isProcessing = false;
                        updateStatusDisplay();
                    }
                } catch(e) {
                    // 发生异常，恢复按钮状态
                    tcpdumpState.isProcessing = false;
                    updateStatusDisplay();
                }
            } else {
                // 网络错误，恢复按钮状态
                tcpdumpState.isProcessing = false;
                updateStatusDisplay();
            }
        }
    };
    xhr.send('interface=' + encodeURIComponent(interface) + 
             '&filter=' + encodeURIComponent(filter) + 
             '&filesize=' + encodeURIComponent(filesize));
}

// 停止抓包
function stopCapture() {
    // 防止重复点击
    if (tcpdumpState.isProcessing) return;
    tcpdumpState.isProcessing = true;
    
    var stopBtn = document.getElementById('btn-stop');
    
    // 立即更新按钮状态
    if (stopBtn) stopBtn.disabled = true;
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/stop")%>', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var result = JSON.parse(xhr.responseText);
                // 无论成功与否，都更新状态
                setTimeout(function() {
                    updateStatusDisplay();
                    setTimeout(updateStatusDisplay, 1000);
                }, 1000);
            } catch(e) {
                // 发生异常，恢复按钮状态
                tcpdumpState.isProcessing = false;
                updateStatusDisplay();
            }
        } else {
            // 网络错误，恢复按钮状态
            tcpdumpState.isProcessing = false;
            updateStatusDisplay();
        }
    };
    xhr.send();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始状态检查
    updateStatusDisplay();
    
    // 加载网络接口
    loadInterfaces();
    
    // 绑定刷新接口按钮事件
    var refreshBtn = document.getElementById('btn-refresh-interfaces');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadInterfaces);
    }
    
    // 定期更新状态
    setInterval(updateStatusDisplay, 3000);
});

//]]>
</script>

<style type="text/css">
/* 按钮容器布局 */
.cbi-value-field {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 统一的按钮基础样式 */
.cbi-button {
    min-width: 120px;
    height: 36px;
    padding: 0 16px;
    font-size: 14px;
    line-height: 36px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid;
    border-radius: 4px;
    cursor: pointer;
    display: inline-block;
    box-sizing: border-box;
    text-decoration: none;
    white-space: nowrap;
    
    /* 强制字体颜色和样式 */
    color: #ffffff !important;
    font-weight: bold !important;
    text-shadow: none !important;
    -webkit-text-fill-color: #ffffff !important;
}

/* 应用按钮样式 - 绿色 */
.cbi-button-apply {
    background-color: #8bc34a !important;
    background-image: none !important;
    border-color: #7cb342 !important;
}

.cbi-button-apply:hover:not(:disabled) {
    background-color: #7cb342 !important;
}

/* 重置按钮样式 - 红色 */
.cbi-button-reset {
    background-color: #f44336 !important;
    background-image: none !important;
    border-color: #e53935 !important;
}

.cbi-button-reset:hover:not(:disabled) {
    background-color: #e53935 !important;
}

/* 动作按钮样式 - 蓝色 */
.cbi-button-action {
    background-color: #2196f3 !important;
    background-image: none !important;
    border-color: #1e88e5 !important;
}

.cbi-button-action:hover:not(:disabled) {
    background-color: #1e88e5 !important;
}

/* 禁用按钮样式 */
.cbi-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    color: #ffffff !important;
}

/* 覆盖LuCI可能存在的默认按钮样式 */
input.cbi-button[class*="cbi-button-"],
button.cbi-button[class*="cbi-button-"] {
    color: #ffffff !important;
}

/* 文件大小输入框样式 */
#filesize {
    text-align: center;
}

/* 刷新接口按钮特殊样式 */
#btn-refresh-interfaces {
    min-width: 100px !important;
    width: 100px !important;
    height: 34px !important;
    line-height: 34px !important;
    padding: 0 12px !important;
    font-size: 12px !important;
    margin-left: 10px;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* 网络接口选择框样式 */
#interface {
    height: 34px;
    min-width: 150px;
}

/* 确保按钮和选择框对齐 */
.cbi-value-field {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}
</style>

<%+footer%>
