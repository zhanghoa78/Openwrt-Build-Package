name: ğŸ› ï¸ ç¼–è¯‘ luci-app-tcpdump

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'SDK ä¸‹è½½é“¾æ¥ï¼ˆå¿…é¡»æ˜¯ .tar.xz æ ¼å¼ï¼‰'
        required: true
        default: 'https://downloads.immortalwrt.org/releases/23.05.7/targets/ramips/mt7620/immortalwrt-sdk-23.05.7-ramips-mt7620_gcc-12.3.0_musl.Linux-x86_64.tar.xz'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      PACKAGE_NAME: luci-app-tcpdump

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: â¬ æ£€å‡ºæ’ä»¶ä»£ç 
        uses: actions/checkout@v4
        with:
          path: plugin

      # æ­¥éª¤ 2ï¼šä¸‹è½½å¹¶è§£å‹ SDK å¹¶å¤åˆ¶æ’ä»¶
      - name: ğŸ“¥ ä¸‹è½½ã€è§£å‹ SDK å¹¶å¤åˆ¶æ’ä»¶
        env:
          SDK_URL: ${{ github.event.inputs.sdk_url }}
        run: |
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ SDKï¼š$SDK_URL"
          wget --quiet "$SDK_URL" -O sdk.tar.xz || { echo "âŒ SDK ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼"; exit 1; }
          echo "ğŸ“¦ æ­£åœ¨è§£å‹ SDK..."
          tar -xf sdk.tar.xz
          mv *-sdk-* sdk
          
          # âœ… å…³é”®ä¿®æ”¹ï¼šæ£€æŸ¥æ’ä»¶ç›®å½•ç»“æ„
          echo "ğŸ” æ£€æŸ¥æ’ä»¶ç›®å½•ç»“æ„..."
          if [ -d "plugin/luci-app-tcpdump" ]; then
            echo "âœ… æ‰¾åˆ° plugin/luci-app-tcpdump ç›®å½•"
            ls -la plugin/luci-app-tcpdump/
          elif [ -d "plugin" ]; then
            echo "ğŸ“ å½“å‰ plugin ç›®å½•å†…å®¹:"
            ls -la plugin/
            # å¦‚æœæ’ä»¶æ–‡ä»¶ç›´æ¥åœ¨ plugin ç›®å½•ä¸‹ï¼Œåˆ›å»ºæ­£ç¡®çš„åŒ…ç»“æ„
            mkdir -p plugin/luci-app-tcpdump
            cp -r plugin/* plugin/luci-app-tcpdump/ 2>/dev/null || true
          else
            echo "âŒ æœªæ‰¾åˆ°æ’ä»¶æ–‡ä»¶"
            exit 1
          fi
          
          # å¤åˆ¶æ’ä»¶åˆ° SDK
          mkdir -p sdk/package/custom
          cp -r plugin/luci-app-tcpdump sdk/package/custom/
          echo "âœ… æ’ä»¶å·²å¤åˆ¶åˆ° sdk/package/custom/luci-app-tcpdump/"

      # æ­¥éª¤ 3ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–
      - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -qq
          sudo apt install -y -qq build-essential ccache ecj fastjar file g++ gawk \
            gettext git libelf-dev libncurses5-dev libssl-dev python3 python3-dev \
            python3-pip python3-setuptools python3-wheel unzip wget xz-utils zlib1g-dev

      # æ­¥éª¤ 4ï¼šæ›´æ–° feeds
      - name: ğŸ”„ æ›´æ–° feeds
        working-directory: ./sdk
        run: |
          echo "ğŸ”„ æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…æº..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # æ­¥éª¤ 5ï¼šç”Ÿæˆé…ç½®
      - name: âš™ï¸ ç”Ÿæˆéäº¤äº’å¼é…ç½®
        working-directory: ./sdk
        run: |
          make defconfig
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-lib-nixio=y" >> .config
          echo "CONFIG_PACKAGE_luci-mod-rpc=y" >> .config
          echo "CONFIG_PACKAGE_tcpdump=y" >> .config
          echo "CONFIG_PACKAGE_libpcap=y" >> .config
          echo "CONFIG_PACKAGE_${{ env.PACKAGE_NAME }}=m" >> .config
          make defconfig
          echo "âœ… éäº¤äº’å¼é…ç½®å·²ç”Ÿæˆ"

      # æ­¥éª¤ 6ï¼šç¼–è¯‘æ’ä»¶
      - name: ğŸ› ï¸ ç¼–è¯‘æ’ä»¶
        working-directory: ./sdk
        run: |
          echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘æ’ä»¶ï¼š${{ env.PACKAGE_NAME }}"
          # å…ˆæ£€æŸ¥åŒ…æ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥åŒ…ç›®å½•..."
          find package/ -name "${{ env.PACKAGE_NAME }}" -type d
          
          # ç¼–è¯‘ç‰¹å®šåŒ…
          make package/custom/${{ env.PACKAGE_NAME }}/compile V=s -j$(nproc)

      # æ­¥éª¤ 7ï¼šä¸Šä¼  IPK æ–‡ä»¶
      - name: ğŸ“¤ ä¸Šä¼  .ipk æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-ipk
          path: sdk/bin/packages/**/**/*.ipk
          if-no-files-found: error

      # æ­¥éª¤ 8ï¼šæ˜¾ç¤ºç¼–è¯‘ç»“æœ
      - name: ğŸ“‹ æ˜¾ç¤ºç¼–è¯‘ç»“æœ
        run: |
          echo "ğŸ“¦ ç¼–è¯‘å®Œæˆçš„ IPK æ–‡ä»¶ï¼š"
          find sdk/bin/packages -name "*.ipk" -type f
