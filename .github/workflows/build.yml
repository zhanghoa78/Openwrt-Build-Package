# å·¥ä½œæµåç§°
name: ğŸ› ï¸ ç¼–è¯‘ luci-app-tcpdump (è¾“å…¥ SDK é“¾æ¥)

# è§¦å‘æ–¹å¼ï¼šä»…æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'SDK ä¸‹è½½é“¾æ¥ï¼ˆå¿…é¡»æ˜¯ .tar.xz æ ¼å¼ï¼‰'
        required: true
        # âœ… æ”¹å›æ‚¨æœ€åˆæŒ‡å®šçš„ ramips/mt7620 ç›®æ ‡ SDK
        default: 'https://downloads.immortalwrt.org/releases/23.05.7/targets/ramips/mt7620/immortalwrt-sdk-23.05.7-ramips-mt7620_gcc-12.3.0_musl.Linux-x86_64.tar.xz'

jobs:
  build:
    # åœ¨ Ubuntu 22.04 ç¯å¢ƒä¸­è¿è¡Œ
    runs-on: ubuntu-22.04

    # âœ… [å…³é”®] æ›´æ”¹ä¸ºæ‚¨çš„åŒ…å
    env:
      PACKAGE_NAME: luci-app-tcpdump

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå³ä½ çš„æ’ä»¶ï¼‰
      - name: â¬ æ£€å‡ºæ’ä»¶ä»£ç 
        uses: actions/checkout@v4
        with:
          path: plugin  # å°†ä»£ç æ£€å‡ºåˆ° plugin/ ç›®å½•

      # æ­¥éª¤ 2ï¼šä¸‹è½½å¹¶è§£å‹å®˜æ–¹ SDK
      - name: ğŸ“¥ ä¸‹è½½ã€è§£å‹ SDK å¹¶å¤åˆ¶æ’ä»¶
        env:
          SDK_URL: ${{ github.event.inputs.sdk_url }}
        run: |
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ SDKï¼š$SDK_URL"
          wget --quiet "$SDK_URL" -O sdk.tar.xz || { echo "âŒ SDK ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼"; exit 1; }

          echo "ğŸ“¦ æ­£åœ¨è§£å‹ SDK..."
          tar -xf sdk.tar.xz
          mv *-sdk-* sdk

          # â­ï¸ å¤åˆ¶æ’ä»¶åˆ° SDK çš„ package/custom/ ç›®å½•
          # (è¿™è¦æ±‚æ‚¨çš„ä»“åº“æ ¹ç›®å½•ä¸­æœ‰ä¸€ä¸ª 'luci-app-tcpdump' æ–‡ä»¶å¤¹)
          mkdir -p sdk/package/custom
          cp -r plugin/${{ env.PACKAGE_NAME }} sdk/package/custom/
          echo "âœ… æ’ä»¶å·²å¤åˆ¶åˆ° sdk/package/custom/${{ env.PACKAGE_NAME }}/"

      # æ­¥éª¤ 3ï¼šå®‰è£…ç¼–è¯‘æ‰€éœ€ç³»ç»Ÿä¾èµ–
      - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -qq
          sudo apt install -y -qq build-essential ccache ecj fastjar file g++ gawk \
            gettext git libelf-dev libncurses5-dev libssl-dev python3 python3-dev \
            python3-pip python3-setuptools python3-wheel unzip wget xz-utils zlib1g-dev

      # æ­¥éª¤ 4ï¼šæ›´æ–°å¹¶å®‰è£… feedsï¼ˆè½¯ä»¶åŒ…ç´¢å¼•ï¼‰
      - name: ğŸ”„ æ›´æ–° feeds
        working-directory: ./sdk
        run: |
          echo "ğŸ”„ æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…æº..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # æ­¥éª¤ 5ï¼šã€å…³é”®ã€‘ç”Ÿæˆéäº¤äº’å¼é…ç½®æ–‡ä»¶
      - name: âš™ï¸ ç”Ÿæˆéäº¤äº’å¼é…ç½®ï¼ˆé˜²æ­¢ç»ˆç«¯é”™è¯¯ï¼‰
        working-directory: ./sdk
        run: |
          # 1. é¦–å…ˆï¼Œç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„ .config æ–‡ä»¶
          make defconfig
          
          # 2. ç„¶åï¼Œä»¥è¿½åŠ ï¼ˆ>>ï¼‰çš„æ–¹å¼æ·»åŠ ä½ éœ€è¦çš„åŒ…
          # (è¿™äº›æ˜¯ luci-app-tcpdump çš„æ‰€æœ‰ä¾èµ–)
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-lib-nixio=y" >> .config
          echo "CONFIG_PACKAGE_luci-mod-rpc=y" >> .config
          echo "CONFIG_PACKAGE_tcpdump=y" >> .config
          
          # 3. ç»Ÿä¸€ä½¿ç”¨å˜é‡ï¼Œå°†æˆ‘ä»¬çš„æ’ä»¶è®¾ä¸ºæ¨¡å—ï¼ˆ=m è¡¨ç¤ºç¼–è¯‘ä½†ä¸å†…ç½®ï¼‰
          echo "CONFIG_PACKAGE_${{ env.PACKAGE_NAME }}=m" >> .config
          
          # 4. æœ€åï¼Œå†æ¬¡è¿è¡Œ defconfigï¼Œè®©æ„å»ºç³»ç»Ÿè‡ªåŠ¨è§£æå¹¶é€‰ä¸­æ‰€æœ‰ä¾èµ–
          make defconfig
          echo "âœ… éäº¤äº’å¼é…ç½®å·²ç”Ÿæˆï¼Œä¸ä¼šè§¦å‘ menuconfig"

      # æ­¥éª¤ 6ï¼šç¼–è¯‘æ’ä»¶
      - name: ğŸ› ï¸ ç¼–è¯‘æ’ä»¶
        working-directory: ./sdk
        run: |
          echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘æ’ä»¶ï¼š${{ env.PACKAGE_NAME }}"
          # ç¼–è¯‘ä½äº custom/ ç›®å½•ä¸‹çš„ç‰¹å®šåŒ…
          make package/custom/${{ env.PACKAGE_NAME }}/compile V=s

      # æ­¥éª¤ 7ï¼šä¸Šä¼ ç”Ÿæˆçš„ .ipk æ–‡ä»¶ä½œä¸ºæ„ä»¶
      - name: ğŸ“¤ ä¸Šä¼  .ipk æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-ipk # æ„ä»¶åç§°ï¼ˆä½¿ç”¨å˜é‡ï¼‰
          path: sdk/bin/packages/**/**/*.ipk  # è‡ªåŠ¨åŒ¹é…æ‰€æœ‰ .ipk
          if-no-files-found: error  # å¦‚æœæ²¡æ‰¾åˆ° .ipk åˆ™æŠ¥é”™
